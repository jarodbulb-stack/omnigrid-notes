<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIGRID Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@300;400;700;900&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00ffff;
            --accent-orange: #ff6b35;
            --danger-red: #ff0040;
            --success-green: #00ff88;
            --dark-bg: #0a0a0a;
            --medium-bg: #1a1a2e;
            --light-bg: #16213e;
            --text-light: #ffffff;
            --text-dim: #888888;
            --border-color: #333333;
            --glow-cyan: rgba(0, 255, 255, 0.3);
            --glow-orange: rgba(255, 107, 53, 0.3);
            --glow-red: rgba(255, 0, 64, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, var(--dark-bg), var(--medium-bg), var(--light-bg));
            color: var(--neon-cyan);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border: 2px solid var(--neon-cyan);
            border-radius: 20px;
            box-shadow: 0 0 30px var(--glow-cyan);
            backdrop-filter: blur(10px);
        }

        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .orbit-title {
            width: 60px;
            height: 60px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .orbit-ring {
            position: absolute;
            border: 2px solid var(--neon-cyan);
            border-radius: 50%;
            opacity: 0.9;
        }

        .orbit-ring:nth-child(1) {
            width: 50px;
            height: 30px;
            top: 15px;
            left: 5px;
            animation: orbit-spin 8s linear infinite;
        }

        .orbit-ring:nth-child(2) {
            width: 38px;
            height: 22px;
            top: 19px;
            left: 11px;
            animation: orbit-spin 6s linear infinite reverse;
        }

        .orbit-ring:nth-child(3) {
            width: 26px;
            height: 16px;
            top: 22px;
            left: 17px;
            animation: orbit-spin 4s linear infinite;
        }

        @keyframes orbit-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .main-title {
            font-family: 'Orbitron', monospace;
            font-size: 3.5em;
            font-weight: 900;
            letter-spacing: 8px;
            text-shadow: 0 0 20px var(--neon-cyan);
            transition: all 0.4s ease;
            cursor: pointer;
            color: var(--neon-cyan);
        }

        .main-title:hover {
            text-shadow: 
                0 0 30px var(--neon-cyan),
                0 0 40px var(--neon-cyan),
                0 0 50px var(--neon-cyan);
            transform: scale(1.02);
        }

        /* Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panel Styles */
        .panel {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--neon-cyan);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 25px var(--glow-cyan);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .panel:hover {
            border-color: var(--accent-orange);
            box-shadow: 0 0 35px var(--glow-orange);
            transform: translateY(-2px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--accent-orange);
            text-shadow: 0 0 10px var(--accent-orange);
        }

        .panel-stats {
            font-size: 0.85em;
            color: var(--text-dim);
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        /* Search and Controls */
        .search-container {
            margin-bottom: 12px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s ease;
            height: 32px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 12px var(--glow-cyan);
        }

        .search-input::placeholder {
            color: var(--text-dim);
        }

        .controls {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 4px 10px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--accent-orange));
            border: none;
            border-radius: 15px;
            color: var(--dark-bg);
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            font-size: 0.75em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            min-width: 60px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background: linear-gradient(45deg, var(--danger-red), var(--accent-orange));
            transform: translateY(-1px);
            box-shadow: 0 3px 12px var(--glow-red);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(0, 255, 255, 0.15);
            color: var(--neon-cyan);
            border: 1px solid var(--neon-cyan);
        }

        .btn-secondary:hover {
            background: rgba(255, 0, 64, 0.2);
            border-color: var(--danger-red);
            color: var(--danger-red);
        }

        /* Notes Container */
        .notes-container {
            min-height: 320px;
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
        }

        .notes-container::-webkit-scrollbar {
            width: 6px;
        }

        .notes-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .notes-container::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 3px;
        }

        .note-item {
            background: rgba(0, 255, 255, 0.08);
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .note-item:hover {
            background: rgba(0, 255, 255, 0.15);
            border-color: var(--accent-orange);
            transform: translateX(3px);
            box-shadow: 0 0 12px var(--glow-orange);
        }

        .note-content {
            flex: 1;
            min-width: 0;
        }

        .note-title {
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 4px;
            font-size: 1em;
            word-wrap: break-word;
        }

        .note-preview {
            color: var(--text-dim);
            font-size: 0.8em;
            margin-bottom: 6px;
            word-wrap: break-word;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .note-meta {
            font-size: 0.7em;
            color: var(--accent-orange);
            opacity: 0.8;
        }

        .note-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .action-btn {
            background: rgba(0, 255, 255, 0.15);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.65em;
            font-weight: 500;
            transition: all 0.3s ease;
            height: 20px;
            min-width: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(255, 0, 64, 0.2);
            border-color: var(--danger-red);
            color: var(--danger-red);
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-dim);
            font-style: italic;
        }

        .empty-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Vault Specific Styles */
        .vault-panel {
            border-color: var(--accent-orange);
            box-shadow: 0 0 25px var(--glow-orange);
        }

        .vault-locked {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .vault-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            color: var(--accent-orange);
        }

        .unlock-btn {
            background: linear-gradient(45deg, var(--accent-orange), #ffaa44);
            color: var(--dark-bg);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.95em;
            cursor: pointer;
            margin: 12px 0;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .unlock-btn:hover {
            background: linear-gradient(45deg, var(--danger-red), var(--accent-orange));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--glow-red);
        }

        .vault-unlocked {
            display: none;
        }

        /* Quote Section */
        .quote-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .quote-text {
            font-size: 0.85em;
            color: var(--neon-cyan);
            font-style: italic;
            text-align: center;
            margin-bottom: 12px;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 8px var(--neon-cyan);
            line-height: 1.3;
        }

        .quote-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .quote-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 4px 8px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8em;
            transition: all 0.3s ease;
            width: 30px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quote-btn:hover {
            background: rgba(255, 0, 64, 0.25);
            border-color: var(--danger-red);
            color: var(--danger-red);
            transform: scale(1.1);
            box-shadow: 0 0 8px var(--glow-red);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark-bg), var(--medium-bg));
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 40px var(--glow-cyan);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-orange);
            font-size: 1.3em;
            text-shadow: 0 0 8px var(--accent-orange);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: var(--neon-cyan);
            font-weight: 600;
            font-size: 0.85em;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .form-textarea {
            min-height: 180px;
            resize: vertical;
            font-family: 'Roboto Mono', monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 12px var(--glow-cyan);
        }

        .form-input[readonly] {
            background: rgba(0, 0, 0, 0.5);
            border-color: var(--text-dim);
            color: var(--text-dim);
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--accent-orange));
            color: var(--dark-bg);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            box-shadow: 0 0 25px var(--glow-cyan);
            font-family: 'Orbitron', monospace;
            font-size: 0.85em;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, var(--danger-red), #ff6666);
        }

        .notification.success {
            background: linear-gradient(45deg, var(--success-green), #66ff99);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-title {
                font-size: 2.2em;
                letter-spacing: 4px;
            }
            
            .controls {
                gap: 4px;
            }
            
            .btn {
                padding: 3px 8px;
                font-size: 0.7em;
                min-width: 50px;
                height: 24px;
            }
            
            .modal-content {
                padding: 18px;
                margin: 10px;
            }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="title-container">
                <div class="orbit-title">
                    <div class="orbit-ring"></div>
                    <div class="orbit-ring"></div>
                    <div class="orbit-ring"></div>
                </div>
                <h1 class="main-title">MNIGRID</h1>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- General Notes Panel -->
            <section class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">GENERAL NOTES</h2>
                    <span class="panel-stats" id="generalStats">0 notes</span>
                </div>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="generalSearch" placeholder="Search notes...">
                </div>
                
                <div class="controls">
                    <button class="btn" onclick="showCreateModal('general')">New</button>
                    <button class="btn" onclick="exportNotes('general')">Export</button>
                    <button class="btn" onclick="importNotes('general')">Import</button>
                    <button class="btn btn-secondary" onclick="clearNotes('general')">Clear</button>
                </div>
                
                <div class="notes-container" id="generalNotes">
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <div>No notes yet. Create your first note!</div>
                    </div>
                </div>
            </section>

            <!-- Vault Panel -->
            <section class="panel vault-panel">
                <div class="panel-header">
                    <h2 class="panel-title">VAULT NOTES</h2>
                    <span class="panel-stats" id="vaultStats">Secured</span>
                </div>
                
                <!-- Locked State -->
                <div id="vaultLocked" class="vault-locked">
                    <div class="vault-icon">🔒</div>
                    <h3>Secure Storage</h3>
                    <p>PIN Protected (Default: 1234)</p>
                    <button class="unlock-btn" onclick="showPinModal()">UNLOCK VAULT</button>
                </div>
                
                <!-- Unlocked State -->
                <div id="vaultUnlocked" class="vault-unlocked">
                    <div class="search-container">
                        <input type="text" class="search-input" id="vaultSearch" placeholder="Search vault notes...">
                    </div>
                    
                    <div class="controls">
                        <button class="btn" onclick="showCreateModal('vault')">New</button>
                        <button class="btn" onclick="exportNotes('vault')">Export</button>
                        <button class="btn" onclick="importNotes('vault')">Import</button>
                        <button class="btn btn-secondary" onclick="clearNotes('vault')">Clear</button>
                        <button class="btn btn-secondary" onclick="showChangePinModal()">Change PIN</button>
                        <button class="btn btn-secondary" onclick="lockVault()">Lock</button>
                    </div>
                    
                    <div class="notes-container" id="vaultNotes">
                        <div class="empty-state">
                            <div class="empty-icon">🔐</div>
                            <div>No vault notes yet. Create your first secure note!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quote Section -->
                <div class="quote-section">
                    <div class="quote-text" id="quoteText">Hard times create strong men. Strong men create good times.</div>
                    <div class="quote-controls">
                        <button class="quote-btn" onclick="previousQuote()">‹</button>
                        <button class="quote-btn" onclick="nextQuote()">›</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="pinModalTitle">🔐 Enter PIN</h3>
            </div>
            <div class="form-group">
                <label class="form-label">PIN:</label>
                <input type="password" class="form-input" id="pinInput" placeholder="Enter PIN..." maxlength="20">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="submitPin()">Submit</button>
                <button class="btn btn-secondary" onclick="closeModal('pin')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="noteModalTitle">📝 Create New Note</h3>
            </div>
            <div class="form-group">
                <label class="form-label">Title:</label>
                <input type="text" class="form-input" id="noteTitle" placeholder="Enter note title...">
            </div>
            <div class="form-group">
                <label class="form-label">Content:</label>
                <textarea class="form-input form-textarea" id="noteContent" placeholder="Enter note content..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveNote()">Save</button>
                <button class="btn btn-secondary" onclick="closeModal('note')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📄 Note Details</h3>
            </div>
            <div class="form-group">
                <label class="form-label">Title:</label>
                <input type="text" class="form-input" id="viewTitle" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Content:</label>
                <textarea class="form-input form-textarea" id="viewContent" readonly></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Created:</label>
                <input type="text" class="form-input" id="viewDate" readonly>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="editFromView()">Edit</button>
                <button class="btn btn-secondary" onclick="deleteFromView()">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('view')">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" style="display: none;" accept=".json">

    <script>
        // Global App Data
        let appData = {
            generalNotes: [],
            vaultNotes: [],
            vaultPin: '1234',
            vaultUnlocked: false,
            currentQuoteIndex: 0,
            editingNote: null,
            editingType: null,
            pinAction: null,
            importType: null,
            viewingNote: null,
            viewingType: null
        };

        const quotes = [
            "Hard times create strong men. Strong men create good times.",
            "Excellence is not an act but a habit.",
            "Fear is a reaction. Courage is a decision.",
            "Knowledge is potential power; applied knowledge is freedom.",
            "Dreams don't work unless you do.",
            "The mind is everything. What you think you become.",
            "Every day is a chance to reinvent yourself.",
            "Progress, not perfection, is the goal.",
            "Success is the sum of small efforts repeated daily.",
            "Your notes today become your wisdom tomorrow."
        ];

        // Data Functions
        function saveData() {
            try {
                localStorage.setItem('mnigrid-data', JSON.stringify({
                    generalNotes: appData.generalNotes,
                    vaultNotes: appData.vaultNotes,
                    vaultPin: appData.vaultPin,
                    currentQuoteIndex: appData.currentQuoteIndex
                }));
            } catch (e) {
                console.warn('Could not save data');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('mnigrid-data');
                if (saved) {
                    const data = JSON.parse(saved);
                    appData.generalNotes = data.generalNotes || [];
                    appData.vaultNotes = data.vaultNotes || [];
                    appData.vaultPin = data.vaultPin || '1234';
                    appData.currentQuoteIndex = data.currentQuoteIndex || 0;
                }
            } catch (e) {
                console.warn('Could not load data');
            }
        }

        // UI Functions with safety checks
        function render() {
            // Clear any existing content first to prevent duplication
            const generalContainer = document.getElementById('generalNotes');
            const vaultContainer = document.getElementById('vaultNotes');
            
            if (generalContainer) generalContainer.innerHTML = '';
            if (vaultContainer) vaultContainer.innerHTML = '';
            
            renderNotes('general');
            renderNotes('vault');
            updateStats();
            updateQuote();
        }

        function renderNotes(type) {
            const notes = type === 'general' ? appData.generalNotes : appData.vaultNotes;
            const container = document.getElementById(type + 'Notes');
            
            if (!container) return;
            
            // Ensure container is empty before rendering
            container.innerHTML = '';
            
            if (notes.length === 0) {
                const icon = type === 'general' ? '📝' : '🔐';
                const text = type === 'general' ? 'No notes yet. Create your first note!' : 'No vault notes yet. Create your first secure note!';
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">${icon}</div><div>${text}</div></div>`;
                return;
            }

            notes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-item fade-in';
                
                const preview = note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content;
                
                noteEl.innerHTML = `
                    <div class="note-content" onclick="viewNote(${note.id}, '${type}')">
                        <div class="note-title">${escapeHtml(note.title)}</div>
                        <div class="note-preview">${escapeHtml(preview)}</div>
                        <div class="note-meta">${note.created}${note.modified ? ' • Modified: ' + note.modified : ''}</div>
                    </div>
                    <div class="note-actions">
                        <button class="action-btn" onclick="editNote(${note.id}, '${type}')">Edit</button>
                        <button class="action-btn" onclick="deleteNote(${note.id}, '${type}')">Delete</button>
                    </div>
                `;
                
                container.appendChild(noteEl);
            });
        }

        function updateStats() {
            document.getElementById('generalStats').textContent = `${appData.generalNotes.length} note${appData.generalNotes.length !== 1 ? 's' : ''}`;
            document.getElementById('vaultStats').textContent = appData.vaultUnlocked ? 
                `${appData.vaultNotes.length} vault note${appData.vaultNotes.length !== 1 ? 's' : ''}` : 'Secured';
        }

        function updateQuote() {
            document.getElementById('quoteText').textContent = quotes[appData.currentQuoteIndex];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Note Operations
        function showCreateModal(type) {
            if (type === 'vault' && !appData.vaultUnlocked) {
                showNotification('Vault must be unlocked to create notes', 'error');
                return;
            }

            appData.editingNote = null;
            appData.editingType = type;
            
            document.getElementById('noteModalTitle').textContent = type === 'general' ? '📝 Create New Note' : '🔒 Create Vault Note';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            
            showModal('note');
            document.getElementById('noteTitle').focus();
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                showNotification('Please fill in both title and content', 'error');
                return;
            }

            if (appData.editingNote) {
                // Update existing note
                const notes = appData.editingType === 'general' ? appData.generalNotes : appData.vaultNotes;
                const noteIndex = notes.findIndex(n => n.id === appData.editingNote);
                
                if (noteIndex !== -1) {
                    notes[noteIndex].title = title;
                    notes[noteIndex].content = content;
                    notes[noteIndex].modified = new Date().toLocaleDateString();
                    showNotification('Note updated successfully!', 'success');
                }
            } else {
                // Create new note
                const note = {
                    id: Date.now() + Math.random(),
                    title: title,
                    content: content,
                    created: new Date().toLocaleDateString(),
                    createdTime: new Date().toLocaleTimeString()
                };

                if (appData.editingType === 'general') {
                    appData.generalNotes.unshift(note);
                } else {
                    appData.vaultNotes.unshift(note);
                }
                
                showNotification(`${appData.editingType === 'general' ? 'Note' : 'Vault note'} created successfully!`, 'success');
            }

            saveData();
            render();
            closeModal('note');
        }

        function editNote(id, type) {
            const notes = type === 'general' ? appData.generalNotes : appData.vaultNotes;
            const note = notes.find(n => n.id === id);
            
            if (!note) return;

            appData.editingNote = id;
            appData.editingType = type;
            
            document.getElementById('noteModalTitle').textContent = '✏️ Edit Note';
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            
            showModal('note');
            document.getElementById('noteTitle').focus();
        }

        function viewNote(id, type) {
            const notes = type === 'general' ? appData.generalNotes : appData.vaultNotes;
            const note = notes.find(n => n.id === id);
            
            if (!note) {
                showNotification('Note not found', 'error');
                return;
            }

            // Set viewing context for edit/delete buttons
            appData.viewingNote = id;
            appData.viewingType = type;

            document.getElementById('viewTitle').value = note.title;
            document.getElementById('viewContent').value = note.content;
            document.getElementById('viewDate').value = `${note.created} ${note.createdTime || ''}${note.modified ? ' • Modified: ' + note.modified : ''}`;

            showModal('view');
        }

        function deleteNote(id, type) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            if (type === 'general') {
                appData.generalNotes = appData.generalNotes.filter(n => n.id !== id);
            } else {
                appData.vaultNotes = appData.vaultNotes.filter(n => n.id !== id);
            }

            saveData();
            render();
            showNotification('Note deleted successfully', 'success');
        }

        function clearNotes(type) {
            if (type === 'vault' && !appData.vaultUnlocked) {
                showNotification('Vault must be unlocked to clear notes', 'error');
                return;
            }

            const notes = type === 'general' ? appData.generalNotes : appData.vaultNotes;
            
            if (notes.length === 0) {
                showNotification(`No ${type} notes to clear`, 'error');
                return;
            }

            if (!confirm(`Delete all ${notes.length} ${type} notes? This cannot be undone.`)) return;

            if (type === 'general') {
                appData.generalNotes = [];
            } else {
                appData.vaultNotes = [];
            }

            saveData();
            render();
            showNotification(`All ${type} notes cleared successfully`, 'success');
        }

        function editFromView() {
            // Capture the viewing context before closing modal
            const noteId = appData.viewingNote;
            const noteType = appData.viewingType;
            
            if (noteId && noteType) {
                closeModal('view');
                editNote(noteId, noteType);
            } else {
                showNotification('Error: No note selected for editing', 'error');
            }
        }

        function deleteFromView() {
            // Capture the viewing context before closing modal
            const noteId = appData.viewingNote;
            const noteType = appData.viewingType;
            
            if (noteId && noteType) {
                closeModal('view');
                deleteNote(noteId, noteType);
            } else {
                showNotification('Error: No note selected for deletion', 'error');
            }
        }

        // Vault Operations
        function showPinModal() {
            appData.pinAction = 'unlock';
            document.getElementById('pinModalTitle').textContent = '🔐 Enter PIN to Unlock Vault';
            document.getElementById('pinInput').value = '';
            showModal('pin');
            document.getElementById('pinInput').focus();
        }

        function showChangePinModal() {
            if (!appData.vaultUnlocked) {
                showNotification('Vault must be unlocked to change PIN', 'error');
                return;
            }
            
            appData.pinAction = 'changeStep1';
            document.getElementById('pinModalTitle').textContent = '🔐 Enter Current PIN';
            document.getElementById('pinInput').value = '';
            showModal('pin');
            document.getElementById('pinInput').focus();
        }

        function submitPin() {
            const pin = document.getElementById('pinInput').value;

            if (appData.pinAction === 'unlock') {
                if (pin === appData.vaultPin) {
                    unlockVault();
                } else {
                    showNotification('Incorrect PIN', 'error');
                }
            } else if (appData.pinAction === 'changeStep1') {
                if (pin === appData.vaultPin) {
                    appData.pinAction = 'changeStep2';
                    document.getElementById('pinModalTitle').textContent = '🔐 Enter New PIN (4-20 characters)';
                    document.getElementById('pinInput').value = '';
                    document.getElementById('pinInput').focus();
                } else {
                    showNotification('Incorrect current PIN', 'error');
                }
            } else if (appData.pinAction === 'changeStep2') {
                if (pin.length >= 4 && pin.length <= 20) {
                    appData.vaultPin = pin;
                    saveData();
                    closeModal('pin');
                    showNotification('PIN changed successfully!', 'success');
                } else {
                    showNotification('PIN must be 4-20 characters', 'error');
                }
            }
        }

        function unlockVault() {
            appData.vaultUnlocked = true;
            document.getElementById('vaultLocked').style.display = 'none';
            document.getElementById('vaultUnlocked').style.display = 'block';
            closeModal('pin');
            render();
            showNotification('Vault unlocked successfully!', 'success');
        }

        function lockVault() {
            appData.vaultUnlocked = false;
            document.getElementById('vaultLocked').style.display = 'block';
            document.getElementById('vaultUnlocked').style.display = 'none';
            render();
            showNotification('Vault locked successfully', 'success');
        }

        // Quote Operations
        function nextQuote() {
            appData.currentQuoteIndex = (appData.currentQuoteIndex + 1) % quotes.length;
            updateQuote();
            saveData();
        }

        function previousQuote() {
            appData.currentQuoteIndex = (appData.currentQuoteIndex - 1 + quotes.length) % quotes.length;
            updateQuote();
            saveData();
        }

        // Import/Export with Universal Compatibility
        function exportNotes(type) {
            const notes = type === 'general' ? appData.generalNotes : appData.vaultNotes;
            
            if (notes.length === 0) {
                showNotification(`No ${type} notes to export`, 'error');
                return;
            }

            // Universal export format - works with all versions
            const exportData = {
                notes: notes,
                type: type,
                version: "1.0",
                appName: "MNIGRID Notes",
                exportDate: new Date().toISOString(),
                platform: "universal"
            };

            const data = JSON.stringify(exportData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mnigrid-${type}-notes-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`Exported ${notes.length} ${type} notes successfully!`, 'success');
        }

        function importNotes(type) {
            if (type === 'vault' && !appData.vaultUnlocked) {
                showNotification('Vault must be unlocked to import notes', 'error');
                return;
            }

            appData.importType = type;
            document.getElementById('fileInput').click();
        }

        // Enhanced file import with universal compatibility
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    let validNotes = [];

                    // Handle multiple import formats for universal compatibility
                    if (Array.isArray(imported)) {
                        // Format 1: Simple array [note1, note2, ...]
                        validNotes = imported;
                    } else if (imported.notes && Array.isArray(imported.notes)) {
                        // Format 2: Object with notes array {notes: [note1, note2, ...]}
                        validNotes = imported.notes;
                    } else if (imported.data && Array.isArray(imported.data)) {
                        // Format 3: Object with data array {data: [note1, note2, ...]}
                        validNotes = imported.data;
                    } else {
                        showNotification('Unsupported file format - no valid notes found', 'error');
                        return;
                    }

                    // Filter and validate notes
                    const processedNotes = validNotes.filter(note => 
                        note && (note.title || note.content)
                    ).map(note => {
                        // Ensure all notes have required fields
                        return {
                            id: note.id || Date.now() + Math.random(),
                            title: note.title || 'Imported Note',
                            content: note.content || '',
                            created: note.created || new Date().toLocaleDateString(),
                            createdTime: note.createdTime || new Date().toLocaleTimeString(),
                            modified: note.modified || null
                        };
                    });

                    if (processedNotes.length === 0) {
                        showNotification('No valid notes found in file', 'error');
                        return;
                    }

                    // Import the notes
                    if (appData.importType === 'general') {
                        appData.generalNotes = [...processedNotes, ...appData.generalNotes];
                    } else {
                        appData.vaultNotes = [...processedNotes, ...appData.vaultNotes];
                    }

                    saveData();
                    render();
                    showNotification(`Successfully imported ${processedNotes.length} notes!`, 'success');

                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Error reading file - invalid JSON format', 'error');
                }
            };

            reader.readAsText(file);
            event.target.value = '';
        }

        // Search function
        function searchNotes(type, query) {
            const notes = type === 'general' ? appData.generalNotes : appData.vaultNotes;
            const container = document.getElementById(type + 'Notes');
            
            if (!query.trim()) {
                renderNotes(type);
                return;
            }

            const filtered = notes.filter(note => 
                note.title.toLowerCase().includes(query.toLowerCase()) ||
                note.content.toLowerCase().includes(query.toLowerCase())
            );

            container.innerHTML = '';
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">🔍</div><div>No matching notes found</div></div>';
                return;
            }

            filtered.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-item fade-in';
                
                const preview = note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content;
                
                noteEl.innerHTML = `
                    <div class="note-content" onclick="viewNote(${note.id}, '${type}')">
                        <div class="note-title">${escapeHtml(note.title)}</div>
                        <div class="note-preview">${escapeHtml(preview)}</div>
                        <div class="note-meta">${note.created}${note.modified ? ' • Modified: ' + note.modified : ''}</div>
                    </div>
                    <div class="note-actions">
                        <button class="action-btn" onclick="editNote(${note.id}, '${type}')">Edit</button>
                        <button class="action-btn" onclick="deleteNote(${note.id}, '${type}')">Delete</button>
                    </div>
                `;
                
                container.appendChild(noteEl);
            });
        }

        // Modal Management
        function showModal(type) {
            document.getElementById(type + 'Modal').classList.add('show');
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').classList.remove('show');
            appData.editingNote = null;
            appData.editingType = null;
            appData.pinAction = null;
            appData.viewingNote = null;
            appData.viewingType = null;
        }

        // Notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Event Listeners
        function setupEventListeners() {
            // Search
            document.getElementById('generalSearch').addEventListener('input', (e) => 
                searchNotes('general', e.target.value));
            document.getElementById('vaultSearch').addEventListener('input', (e) => 
                searchNotes('vault', e.target.value));

            // File import
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (!Array.isArray(imported)) {
                            showNotification('Invalid file format', 'error');
                            return;
                        }

                        const validNotes = imported.filter(note => note && note.title && note.content);
                        if (validNotes.length === 0) {
                            showNotification('No valid notes found', 'error');
                            return;
                        }

                        validNotes.forEach(note => {
                            if (!note.id) note.id = Date.now() + Math.random();
                            if (!note.created) note.created = new Date().toLocaleDateString();
                        });

                        if (appData.importType === 'general') {
                            appData.generalNotes = [...validNotes, ...appData.generalNotes];
                        } else {
                            appData.vaultNotes = [...validNotes, ...appData.vaultNotes];
                        }

                        saveData();
                        render();
                        showNotification(`Successfully imported ${validNotes.length} notes!`, 'success');
                    } catch (error) {
                        showNotification('Error reading file', 'error');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // Keyboard events
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    ['pin', 'note', 'view'].forEach(type => closeModal(type));
                }
                if (e.key === 'Enter' && document.getElementById('pinModal').classList.contains('show')) {
                    e.preventDefault();
                    submitPin();
                }
            });

            // Click outside modal to close
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    ['pin', 'note', 'view'].forEach(type => closeModal(type));
                }
            });
        }

        // Initialize App with duplicate prevention
        let appInitialized = false;

        function init() {
            if (appInitialized) {
                console.log('App already initialized, skipping...');
                return;
            }
            appInitialized = true;
            
            console.log('Initializing MNIGRID Notes...');
            loadData();
            setupEventListeners();
            render();
            showNotification('MNIGRID Notes loaded successfully!', 'success');
        }

        // Single initialization point
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
